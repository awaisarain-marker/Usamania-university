<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UITU Chat</title>
  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --user:#0b74de;
      --bot:#222;
      --muted:#6b7280;
    }
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      margin:0;
    }
    .chat-card{
      width:420px;
      max-width:96vw;
      background:var(--card);
      box-shadow:0 6px 24px rgba(10,20,40,0.08);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:640px;
    }
    .header{
      padding:16px;
      border-bottom:1px solid #eef2f7;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo {
      width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#0b74de,#4aa3ff);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
    }
    .title{font-weight:600}
    .subtitle{font-size:12px;color:var(--muted);margin-top:2px}
    .messages{
      flex:1;
      padding:16px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:
        linear-gradient(180deg, rgba(11,116,222,0.02), transparent 60%);
    }
    .msg{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.3}
    .msg.user{align-self:flex-end;background:linear-gradient(90deg,var(--user),#2f9cff);color:white;border-bottom-right-radius:4px}
    .msg.bot{align-self:flex-start;background:#f3f6fb;color:var(--bot);border-bottom-left-radius:4px}
    .meta{font-size:11px;color:var(--muted);margin-bottom:6px}
    .input-area{
      display:flex;
      gap:8px;
      padding:12px;
      border-top:1px solid #eef2f7;
      align-items:center;
    }
    .input-area input[type="text"]{
      flex:1;border:1px solid #e6eefc;padding:10px 12px;border-radius:10px;font-size:14px;
    }
    .input-area button{
      background:var(--user);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;
    }
    .small{font-size:12px;color:var(--muted);text-align:center;padding:8px}
    .loading-dot{display:inline-block;width:6px;height:6px;margin-right:4px;background:#bbb;border-radius:50%;animation:blink 1s infinite}
    @keyframes blink{0%{opacity:0.2}50%{opacity:1}100%{opacity:0.2}}
    .error{color:#b00020;font-size:13px;padding:8px;text-align:center}
  </style>
</head>
<body>

  <div class="chat-card" role="region" aria-label="UIT University Chat">
    <div class="header">
      <div class="logo">UI</div>
      <div>
        <div class="title">UIT University Assistant</div>
        <div class="subtitle">Ask about programs, fees, scholarships, and admissions</div>
      </div>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <div id="error" class="error" style="display:none"></div>

    <div class="input-area">
      <input id="userInput" type="text" placeholder="Type your question (e.g., 'What is the fee for BSCS?')" aria-label="Type your question" />
      <button id="sendBtn">Send</button>
    </div>
    <div class="small">Powered by UIT University chatbot — for official details contact info@uitu.edu.pk</div>
  </div>

<script>
(function(){
  // === CONFIG: set your webhook URL here ===
  const WEBHOOK_URL = "https://rex1280.app.n8n.cloud/webhook/ff5b65c4-ece4-4282-a58d-eaf04ade66b6";

  // DOM elements
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const errorEl = document.getElementById('error');

  // helper to append messages
  function appendMessage(text, who='bot'){
    const container = document.createElement('div');
    container.className = 'msg ' + (who==='user' ? 'user' : 'bot');
    
    if(who === 'user'){
      // Keep escaping for user input
      container.innerHTML = `<div>${escapeHtml(text)}</div>`;
    } else {
      // Render HTML directly for bot messages
      container.innerHTML = `<div>${text}</div>`;
    }

    messagesEl.appendChild(container);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return container;
  }

  function escapeHtml(unsafe){
    return unsafe
      .replaceAll('&', '&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // Try to extract a useful textual answer from the webhook response
  async function extractTextFromResponse(resp){
    // Try JSON first
    try {
      const json = await resp.clone().json().catch(()=>null);
      if(json){
        // Common shapes:
        if(typeof json === 'string') return json;
        if(json.answer) return json.answer;
        if(Array.isArray(json) && json.length && typeof json[0] === 'object'){
          // might be an n8n array of objects - try to find common fields
          for(const item of json){
            if(item.answer) return item.answer;
            if(item.text) return item.text;
            if(item.generated_text) return item.generated_text;
            if(item.output) return item.output;
          }
        }
        if(json.choices && json.choices[0] && json.choices[0].message && json.choices[0].message.content){
          return json.choices[0].message.content;
        }
        if(json.generated_text) return json.generated_text;
        // fallback: try to stringify a concise representation
        return JSON.stringify(json);
      }
    } catch(e){
      // not JSON
    }
    // Otherwise plain text
    try {
      const text = await resp.text();
      if(text) return text;
    } catch(e){
      // give up
    }
    return "I couldn't read the response from the server. Please try again later.";
  }

  async function sendMessage(){
    const text = inputEl.value.trim();
    if(!text) return;
    errorEl.style.display = 'none';

    // display user message
    appendMessage(text, 'user');
    inputEl.value = '';
    inputEl.disabled = true;
    sendBtn.disabled = true;

    // show typing indicator
    const typingBubble = document.createElement('div');
    typingBubble.className = 'msg bot';
    typingBubble.innerHTML = '<div class="meta">Assistant is typing</div><div><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></div>';
    messagesEl.appendChild(typingBubble);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: text })
      });

      if(!res.ok){
        // server error
        const errText = await res.text().catch(()=>res.statusText || 'Unknown error');
        throw new Error(`Server error ${res.status}: ${errText}`);
      }

      const answer = await extractTextFromResponse(res);
      // remove typing bubble and append final bot message
      typingBubble.remove();
      appendMessage(answer, 'bot');

    } catch(err){
      typingBubble.remove();
      const errMsg = 'Error: ' + (err.message || 'Network error');
      appendMessage('Sorry — there was a problem sending your message. ' + errMsg, 'bot');
      errorEl.textContent = err.message;
      errorEl.style.display = 'block';
      console.error(err);
    } finally {
      inputEl.disabled = false;
      sendBtn.disabled = false;
      inputEl.focus();
    }
  }

  // event handlers
  sendBtn.addEventListener('click', sendMessage);
  inputEl.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  // welcome message
  appendMessage("Hello! I'm the UIT University assistant. Ask me about programs, fees, scholarships, or admissions. Example: \"What is the fee for BSCS?\"", 'bot');
})();
</script>
</body>
</html>
